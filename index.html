<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur de Mobilité - Agrégation Territoriale</title>

    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #0f172a;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            background: #ffffff;
            padding: 0.8rem 1.5rem;
            color: var(--text);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
            border-bottom: 1px solid #e2e8f0;
        }

        .search-bar {
            display: flex;
            gap: 12px;
            max-width: 800px;
            margin: 0.5rem auto 0;
            background: #f8fafc;
            padding: 6px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            outline: none;
            font-size: 0.95rem;
        }

        button.btn-load {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        button.btn-load:hover { background: #4f46e5; }

        main {
            display: grid;
            grid-template-columns: 400px 1fr;
            flex: 1;
            overflow: hidden;
        }

        .side-panel {
            padding: 20px;
            background: var(--card-bg);
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 0.05em;
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .toggle-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: 0.2s;
        }

        .toggle-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chart-container { height: 220px; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            text-align: left;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #f1f5f9;
        }

        .stat-val { font-size: 1.25rem; font-weight: 800; color: var(--primary); }
        .stat-lab { font-size: 0.7rem; color: #64748b; margin-top: 4px; }

        .site-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
            color: #475569;
            border: 1px solid #f1f5f9;
            border-radius: 8px;
            padding: 8px;
        }

        .site-tag {
            display: inline-block;
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 0.7rem;
        }

        .map-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #map-container { width: 100%; height: 100%; background: #e2e8f0; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 15px;
        }

        .spinner {
            width: 48px; height: 48px;
            border: 5px solid #e2e8f0;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        .layer-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>

    <div class="loading-overlay" id="global-loader">
        <div class="spinner"></div>
        <div id="loader-msg" style="font-weight: 600; color: var(--primary)">Agrégation des données en cours...</div>
    </div>

    <header>
        <div class="search-bar">
            <input type="text" id="input-city" placeholder="Rechercher une ville (ex: Bordeaux, Marseille...)" onkeypress="if(event.key==='Enter') App.fetchByCity()" />
            <button class="btn-load" onclick="App.fetchByCity()">Analyser</button>
        </div>
    </header>

    <main>
        <div class="side-panel">
            <div class="card">
                <div class="card-title">Résumé Territoire</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-val" id="stat-count-sites">0</div>
                        <div class="stat-lab">Sites trouvés</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-val" id="stat-count-total">0</div>
                        <div class="stat-lab">Données cumulées</div>
                    </div>
                </div>
                <div class="site-list" id="site-list-container">
                    <i>Saisissez une ville pour agréger les sites...</i>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Mobilité Territoriale</div>
                <div class="controls">
                    <button class="toggle-btn active" id="btn-dist" onclick="App.setMode('distance')">Distance</button>
                    <button class="toggle-btn" id="btn-time" onclick="App.setMode('time')">Temps</button>
                </div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Analyse Proximité</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-val" id="stat-prox-2km">0</div>
                        <div class="stat-lab">Salariés à -2km</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-val" id="stat-prox-5km">0</div>
                        <div class="stat-lab">Salariés à -5km</div>
                    </div>
                </div>
            </div>

            <div id="console-logs" style="font-size: 0.7rem; font-family: monospace; color: #64748b; padding: 10px; max-height: 150px; overflow-y: auto; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;">
                > Système de débogage prêt.
            </div>
        </div>

        <div class="map-wrapper">
            <div class="layer-toggle">
                <label><input type="checkbox" checked onchange="App.toggleLayer('boundary', this.checked)"> Contour Ville (OSM)</label>
            </div>
            <div id="map-container"></div>
        </div>
    </main>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNrmW4mTLR6O1GUIdmxFkbA6iQ7h3aNxs2gdOrMPfbxleVQqi8Oslq9Disgk3h2ZnKyA/exec";

        const App = {
            state: {
                mode: 'distance',
                rawData: [], 
                sites: [],
                cityBoundary: null,
                cityCenter: [-0.579, 44.837],
                chart: null,
                deck: null,
                visibility: { boundary: true }
            },

            log(msg, type = 'info') {
                const logs = document.getElementById('console-logs');
                const color = type === 'error' ? '#ef4444' : (type === 'debug' ? '#2563eb' : '#64748b');
                logs.innerHTML += `<br><span style="color: ${color}">> ${msg}</span>`;
                logs.scrollTop = logs.scrollHeight;
                console.log(`[${type.toUpperCase()}] ${msg}`);
            },

            showLoader(show, msg) {
                const loader = document.getElementById('global-loader');
                if(msg) document.getElementById('loader-msg').innerText = msg;
                loader.style.display = show ? 'flex' : 'none';
            },

            async fetchByCity() {
                const cityInput = document.getElementById('input-city').value.trim();
                if (!cityInput) return;

                this.showLoader(true, `Interrogation de la base pour ${cityInput}...`);
                this.log(`Début de recherche pour : "${cityInput}"`, 'debug');

                try {
                    // 1. Récupération Contour Ville (Optionnel, n'empêche pas le fonctionnement)
                    this.getCityBoundary(cityInput);

                    // 2. Fetch Aggregated Data
                    const targetUrl = `${SCRIPT_URL}?city=${encodeURIComponent(cityInput)}`;
                    this.log(`Fetch URL : ${targetUrl}`, 'debug');

                    const response = await fetch(targetUrl);
                    const result = await response.json();

                    this.log(`Réponse reçue : ${JSON.stringify(result).substring(0, 100)}...`, 'debug');

                    // Vérification flexible (status ou result selon le script Google)
                    const status = result.status || result.result;
                    const files = result.files || (result.data ? [result.data] : []);

                    if (status !== 'ok' && status !== 'success') {
                        this.log(`Le script a renvoyé une erreur : ${result.message}`, 'error');
                        throw new Error(result.message || "Erreur serveur");
                    }

                    if (!files || files.length === 0) {
                        this.log(`Tableau "files" vide pour la ville : ${cityInput}`, 'error');
                        throw new Error("Aucune donnée trouvée pour cette ville.");
                    }

                    this.log(`${files.length} fichiers CSV trouvés.`, 'debug');
                    this.processAggregatedData(files);

                } catch (err) {
                    this.log(`Échec : ${err.message}`, 'error');
                } finally {
                    this.showLoader(false);
                }
            },

            async getCityBoundary(city) {
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=geojson&q=${encodeURIComponent(city)}&polygon_geojson=1&limit=1`);
                    const data = await resp.json();
                    if (data.features && data.features.length > 0) {
                        this.state.cityBoundary = data.features[0];
                        const geom = data.features[0].geometry;
                        const center = geom.type === "Polygon" ? geom.coordinates[0][0] : geom.coordinates[0][0][0];
                        this.state.cityCenter = center;
                        this.log(`Contour OSM chargé pour ${city}`, 'info');
                    }
                } catch (e) { this.log("Erreur de contour OSM (non bloquant).", 'info'); }
            },

            processAggregatedData(files) {
                let mergedData = [];
                let siteNames = new Set();

                files.forEach((file, index) => {
                    const csvText = file.csv;
                    const siteName = file.site || `Site ${index + 1}`;
                    siteNames.add(siteName);

                    if (!csvText) {
                        this.log(`Attention : Le site "${siteName}" n'a pas de contenu CSV.`, 'error');
                        return;
                    }

                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            this.log(`Site "${siteName}" : ${results.data.length} lignes extraites.`, 'debug');
                            results.data.forEach(row => {
                                row.site = siteName;
                                // Normalisation duree_min -> duration_minutes
                                if (row.duree_min !== undefined) row.duration_minutes = row.duree_min;
                                mergedData.push(row);
                            });
                        }
                    });
                });

                this.state.rawData = mergedData;
                this.state.sites = Array.from(siteNames);
                
                this.log(`Total : ${mergedData.length} lignes agrégées.`, 'info');
                this.updateUI();
                this.renderMap();
            },

            updateUI() {
                document.getElementById('stat-count-sites').innerText = this.state.sites.length;
                document.getElementById('stat-count-total').innerText = this.state.rawData.length;
                const list = document.getElementById('site-list-container');
                list.innerHTML = this.state.sites.map(s => `<span class="site-tag">${s}</span>`).join('');
                this.updateChart();
            },

            setMode(m) {
                this.state.mode = m;
                document.getElementById('btn-dist').classList.toggle('active', m === 'distance');
                document.getElementById('btn-time').classList.toggle('active', m === 'time');
                this.updateChart();
            },

            toggleLayer(id, visible) {
                this.state.visibility[id] = visible;
                this.renderMap();
            },

            updateChart() {
                const isDist = this.state.mode === 'distance';
                const bins = isDist ? { '0-2km': 0, '2-5km': 0, '5-10km': 0, '10km+': 0 } : { '0-10m': 0, '10-20m': 0, '20-30m': 0, '30m+': 0 };

                this.state.rawData.forEach(d => {
                    const val = isDist ? d.distance_km : (d.duree_min || d.duration_minutes);
                    if (val == null) return;
                    if (isDist) {
                        if (val <= 2) bins['0-2km']++;
                        else if (val <= 5) bins['2-5km']++;
                        else if (val <= 10) bins['5-10km']++;
                        else bins['10km+']++;
                    } else {
                        if (val <= 10) bins['0-10m']++;
                        else if (val <= 20) bins['10-20m']++;
                        else if (val <= 30) bins['20-30m']++;
                        else bins['30m+']++;
                    }
                });

                document.getElementById('stat-prox-2km').innerText = bins['0-2km'] || bins['0-10m'];
                document.getElementById('stat-prox-5km').innerText = (bins['0-2km'] + (bins['2-5km'] || 0)) || (bins['0-10m'] + (bins['10-20m'] || 0));

                const ctx = document.getElementById('mainChart').getContext('2d');
                if (this.state.chart) this.state.chart.destroy();
                this.state.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(bins),
                        datasets: [{ data: Object.values(bins), backgroundColor: '#6366f1', borderRadius: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            },

            renderMap() {
                const layers = [
                    new deck.TileLayer({
                        id: 'base-map',
                        data: 'https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                        renderSubLayers: props => {
                            const { bbox: { west, south, east, north } } = props.tile;
                            return new deck.BitmapLayer(props, { data: null, image: props.data, bounds: [west, south, east, north] });
                        }
                    }),
                    new deck.GeoJsonLayer({
                        id: 'city-boundary',
                        data: this.state.cityBoundary,
                        visible: this.state.visibility.boundary,
                        filled: false, stroked: true, getLineColor: [99, 102, 241], getLineWidth: 2
                    })
                ];

                if (!this.state.deck) {
                    this.state.deck = new deck.DeckGL({
                        container: 'map-container',
                        initialViewState: { longitude: this.state.cityCenter[0], latitude: this.state.cityCenter[1], zoom: 12 },
                        controller: true, layers
                    });
                } else {
                    this.state.deck.setProps({ layers, initialViewState: { longitude: this.state.cityCenter[0], latitude: this.state.cityCenter[1], zoom: 12, transitionDuration: 1000, transitionInterpolator: new deck.FlyToInterpolator() } });
                }
            }
        };
    </script>
</body>
</html>
