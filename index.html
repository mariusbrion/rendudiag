<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobilit√© - Agr√©gateur Territorial</title>

    <!-- Biblioth√®ques -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { background-color: #f8fafc; }
        #map-container { height: 100%; width: 100%; position: absolute; top: 0; left: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[1000] hidden flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-indigo-600 font-bold animate-pulse" id="loader-text">Analyse des donn√©es...</p>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 p-4 z-10 shadow-sm">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-4 items-center">
            <h1 class="text-xl font-extrabold text-slate-800 tracking-tight flex-shrink-0">
                üöÄ Mobilit√©<span class="text-indigo-600">Territoire</span>
            </h1>
            <div class="flex w-full gap-2">
                <input type="text" id="input-city" placeholder="Entrez une ville (ex: Bordeaux)" 
                       class="flex-1 bg-slate-100 border-none rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                <button onclick="App.run()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors shadow-md">
                    Analyser
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        <!-- Sidebar Gauche -->
        <div class="w-full md:w-[400px] bg-white border-r border-slate-200 overflow-y-auto z-10 p-6 custom-scrollbar shadow-xl">
            
            <!-- Stats -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center">
                    <span class="block text-2xl font-black text-indigo-600" id="stat-sites">0</span>
                    <span class="text-[10px] uppercase font-bold text-slate-400">Sites identifi√©s</span>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center">
                    <span class="block text-2xl font-black text-indigo-600" id="stat-total">0</span>
                    <span class="text-[10px] uppercase font-bold text-slate-400">Employ√©s total</span>
                </div>
            </div>

            <!-- Liste des sites -->
            <div class="mb-6">
                <h3 class="text-[11px] font-bold text-slate-400 uppercase mb-3 tracking-widest">Sites agr√©g√©s</h3>
                <div id="site-tags" class="flex flex-wrap gap-2">
                    <em class="text-slate-400 text-sm">Aucune donn√©e charg√©e.</em>
                </div>
            </div>

            <!-- Graphique -->
            <div class="bg-white border border-slate-100 rounded-xl p-4 shadow-sm mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-slate-700">Histogramme</h3>
                    <div class="flex bg-slate-100 rounded-lg p-1 gap-1">
                        <button id="btn-dist" onclick="App.setMode('distance')" class="text-[10px] px-3 py-1 rounded-md font-bold transition-all bg-white text-indigo-600 shadow-sm">KM</button>
                        <button id="btn-time" onclick="App.setMode('time')" class="text-[10px] px-3 py-1 rounded-md font-bold transition-all text-slate-500">MIN</button>
                    </div>
                </div>
                <div class="h-[250px]">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- Console simplifi√©e -->
            <div class="bg-slate-900 rounded-lg p-3 font-mono text-[10px] text-emerald-400 max-h-32 overflow-y-auto custom-scrollbar" id="console">
                > Syst√®me pr√™t.
            </div>
        </div>

        <!-- Zone Carte -->
        <div class="flex-1 relative bg-slate-200">
            <div id="map-container"></div>
        </div>
    </main>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxnFMCDrp_wVcIedKXqI9-Gh1dFPhLJV4UMZGg1BOSJVWWbGtNGN9H9LHMa6juZQkmeBA/exec";

        const App = {
            state: {
                mode: 'distance', // 'distance' ou 'time'
                rawData: [],
                sites: [],
                cityBoundary: null,
                cityCenter: [2.3522, 48.8566], // Default Paris
                chart: null,
                deck: null
            },

            log(msg, isError = false) {
                const con = document.getElementById('console');
                const time = new Date().toLocaleTimeString('fr-FR', { hour12: false });
                con.innerHTML += `<br><span class="${isError ? 'text-red-400' : ''}">[${time}] ${msg}</span>`;
                con.scrollTop = con.scrollHeight;
            },

            toggleLoader(show, text = "") {
                const l = document.getElementById('loader');
                if (text) document.getElementById('loader-text').innerText = text;
                l.classList.toggle('hidden', !show);
                l.classList.toggle('flex', show);
            },

            async run() {
                const city = document.getElementById('input-city').value.trim();
                if (!city) return;

                this.toggleLoader(true, `Recherche de ${city}...`);
                this.log(`D√©marrage analyse : ${city}`);

                try {
                    // 1. R√©cup√©rer les contours de la ville (OSM)
                    await this.fetchBoundary(city);

                    // 2. R√©cup√©rer les CSV depuis Google Sheets
                    const response = await fetch(`${SCRIPT_URL}?city=${encodeURIComponent(city)}`);
                    const result = await response.json();

                    if (result.status !== 'ok') throw new Error(result.message || "Erreur Sheets");
                    if (!result.files || result.files.length === 0) throw new Error("Aucune donn√©e pour cette ville");

                    this.log(`${result.files.length} sites trouv√©s.`);
                    
                    // 3. Traiter et Agr√©ger les donn√©es
                    this.processData(result.files);

                } catch (e) {
                    this.log(e.message, true);
                    alert("Erreur: " + e.message);
                } finally {
                    this.toggleLoader(false);
                }
            },

            async fetchBoundary(city) {
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=geojson&q=${encodeURIComponent(city)}&polygon_geojson=1&limit=1`);
                    const data = await resp.json();
                    if (data && data.features.length > 0) {
                        this.state.cityBoundary = data.features[0];
                        // Centrage : Longitude, Latitude
                        const coords = data.features[0].geometry.coordinates;
                        // On prend un point arbitraire pour le centre
                        const center = data.features[0].bbox;
                        this.state.cityCenter = [(center[0] + center[2]) / 2, (center[1] + center[3]) / 2];
                        this.log("Contours de la ville charg√©s.");
                    }
                } catch (err) {
                    this.log("Impossible de charger les contours de la ville.", true);
                }
            },

            processData(files) {
                let aggregated = [];
                let siteList = [];

                files.forEach(f => {
                    siteList.push(f.site);
                    // Parsing synchrone car f.csv est d√©j√† une string
                    const parsed = Papa.parse(f.csv, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });

                    if (parsed.data) {
                        const rows = parsed.data.map(row => ({
                            ...row,
                            _site_origin: f.site,
                            // Normalisation des cl√©s au cas o√π
                            dist: parseFloat(row.distance_km || 0),
                            time: parseInt(row.duree_min || row.duration_min || 0)
                        }));
                        aggregated.push(...rows);
                    }
                });

                this.state.rawData = aggregated;
                this.state.sites = siteList;

                this.updateUI();
                this.renderMap();
                this.log(`Agr√©gation termin√©e : ${aggregated.length} lignes.`);
            },

            updateUI() {
                document.getElementById('stat-sites').innerText = this.state.sites.length;
                document.getElementById('stat-total').innerText = this.state.rawData.length;
                
                const tagsContainer = document.getElementById('site-tags');
                tagsContainer.innerHTML = this.state.sites.map(s => 
                    `<span class="bg-indigo-50 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded border border-indigo-100">${s}</span>`
                ).join('');

                this.updateChart();
            },

            setMode(m) {
                this.state.mode = m;
                const isDist = m === 'distance';
                
                // UI Toggle
                document.getElementById('btn-dist').className = isDist ? 
                    "text-[10px] px-3 py-1 rounded-md font-bold bg-white text-indigo-600 shadow-sm" : 
                    "text-[10px] px-3 py-1 rounded-md font-bold text-slate-500";
                document.getElementById('btn-time').className = !isDist ? 
                    "text-[10px] px-3 py-1 rounded-md font-bold bg-white text-indigo-600 shadow-sm" : 
                    "text-[10px] px-3 py-1 rounded-md font-bold text-slate-500";

                this.updateChart();
            },

            updateChart() {
                const isDist = this.state.mode === 'distance';
                let bins = {};
                
                if (isDist) {
                    bins = { "0-2km": 0, "2-5km": 0, "5-10km": 0, "10-20km": 0, "20km+": 0 };
                    this.state.rawData.forEach(d => {
                        const v = d.dist;
                        if (v <= 2) bins["0-2km"]++;
                        else if (v <= 5) bins["2-5km"]++;
                        else if (v <= 10) bins["5-10km"]++;
                        else if (v <= 20) bins["10-20km"]++;
                        else bins["20km+"]++;
                    });
                } else {
                    bins = { "0-10m": 0, "10-20m": 0, "20-30m": 0, "30-45m": 0, "45m+": 0 };
                    this.state.rawData.forEach(d => {
                        const v = d.time;
                        if (v <= 10) bins["0-10m"]++;
                        else if (v <= 20) bins["10-20m"]++;
                        else if (v <= 30) bins["20-30m"]++;
                        else if (v <= 45) bins["30-45m"]++;
                        else bins["45m+"]++;
                    });
                }

                const ctx = document.getElementById('mainChart').getContext('2d');
                if (this.state.chart) this.state.chart.destroy();

                this.state.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(bins),
                        datasets: [{
                            label: isDist ? 'Nombre d\'employ√©s' : 'Nombre d\'employ√©s',
                            data: Object.values(bins),
                            backgroundColor: '#6366f1',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { display: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            },

            renderMap() {
                const layers = [
                    new deck.TileLayer({
                        id: 'base-map',
                        data: 'https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                        renderSubLayers: props => {
                            const { bbox: { west, south, east, north } } = props.tile;
                            return new deck.BitmapLayer(props, {
                                data: null,
                                image: props.data,
                                bounds: [west, south, east, north]
                            });
                        }
                    })
                ];

                if (this.state.cityBoundary) {
                    layers.push(new deck.GeoJsonLayer({
                        id: 'city-layer',
                        data: this.state.cityBoundary,
                        filled: true,
                        stroked: true,
                        getFillColor: [99, 102, 241, 40],
                        getLineColor: [99, 102, 241, 200],
                        getLineWidth: 3,
                        lineWidthUnits: 'pixels'
                    }));
                }

                if (!this.state.deck) {
                    this.state.deck = new deck.DeckGL({
                        container: 'map-container',
                        initialViewState: {
                            longitude: this.state.cityCenter[0],
                            latitude: this.state.cityCenter[1],
                            zoom: 12,
                            pitch: 0,
                            bearing: 0
                        },
                        controller: true,
                        layers: layers
                    });
                } else {
                    this.state.deck.setProps({
                        layers: layers,
                        initialViewState: {
                            longitude: this.state.cityCenter[0],
                            latitude: this.state.cityCenter[1],
                            zoom: 12,
                            transitionDuration: 1000,
                            transitionInterpolator: new deck.FlyToInterpolator()
                        }
                    });
                }
            }
        };

        // Init vide
        window.onload = () => App.renderMap();
    </script>
</body>
</html>
